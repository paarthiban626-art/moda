<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Flappy Bird with Leaderboard</title>

<style>
html, body {
  height: 100%; margin:0;
  display:flex; align-items:center; justify-content:center;
  background:#70c5ce; 
  /* ‚ùå removed touch-action:none (this blocked inputs on mobile) */
}
#gameWrapper { position:relative; }
canvas {
  display:block; border:6px solid #2b6b6b; border-radius:8px;
  max-width:100vw; height:auto;
}
#overlay {
  position:absolute; left:0; top:0; right:0;
  display:flex; align-items:flex-start; justify-content:flex-start;
  padding:8px; color:#fff; font-weight:700;
  text-shadow:0 1px 0 rgba(0,0,0,0.3); pointer-events:none; font-size:20px;
}
#message {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  background:rgba(255,255,255,0.95); padding:12px 16px; border-radius:8px;
  text-align:center;
}
button { margin-top:8px; padding:8px 12px; border:none; border-radius:6px;
  background:#2b6b6b; color:#fff; font-weight:700; cursor:pointer;
}
input { padding:6px; border-radius:4px; border:1px solid #ccc; margin-top:6px;}
#leaderboard { margin-top:10px; text-align:left; }
</style>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="gameWrapper">
  <canvas id="game" width="400" height="600"></canvas>
  <div id="overlay">Score: <span id="score">0</span></div>
  <div id="message">
    <div id="msgText">Enter your name:</div>
    <input id="playerName" type="text" placeholder="Your name"/>
    <button id="startBtn">Start / Restart</button>
    <div id="leaderboard"></div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAJUkAj4ShSZ-aKFp2dvCEYh9nmxAL1lrA",
    authDomain: "flappy-leaderboard-a4d67.firebaseapp.com",
    databaseURL: "https://flappy-leaderboard-a4d67-default-rtdb.firebaseio.com",
    projectId: "flappy-leaderboard-a4d67",
    storageBucket: "flappy-leaderboard-a4d67.firebasestorage.app",
    messagingSenderId: "868069717929",
    appId: "1:868069717929:web:2a2b0e2894c86e6355f6b8"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  const gravity = 0.45;
  const flapStrength = -8.6;
  const pipeGap = 200, pipeWidth = 60, pipeSpacing = 280, pipeSpeed = 2.6;
  const birdImageSrc = 'bird.jpg';
  const flapSound = new Audio('flap.mp3');
  const hitSound = new Audio('hit.mp3');

  const scoreEl = document.getElementById('score');
  const msgBox = document.getElementById('message');
  const msgText = document.getElementById('msgText');
  const startBtn = document.getElementById('startBtn');
  const playerInput = document.getElementById('playerName');
  const leaderboardDiv = document.getElementById('leaderboard');

  let bird, pipes=[], frame=0, score=0, bestScore=0, running=false, soundsUnlocked=false;
  let playerName = '';

  function createBird(img){
    return {x:80, y:H/2, vy:0, w:Math.min(40,img.width*0.4), h:Math.min(32,img.height*0.4),
      img, rotation:0,
      update(){ this.vy += gravity; this.y += this.vy; this.rotation = Math.max(-0.6, Math.min(1.2, this.vy*0.06));
        if(this.y+this.h/2>=H){ this.y=H-this.h/2; this.vy=0;}
        if(this.y-this.h/2<=0){ this.y=this.h/2; this.vy=0; }},
      flap(){ this.vy=flapStrength; playSound(flapSound);}
    };
  }

  function spawnPipe(x){
    const margin=60, min=margin+pipeGap/2, max=H-margin-pipeGap/2;
    const gapCenter=Math.floor(Math.random()*(max-min+1))+min;
    return {x, gapY:gapCenter, passed:false,
      update(){ this.x -= pipeSpeed; },
      offScreen(){ return this.x+pipeWidth<0; },
      draw(ctx){ ctx.fillStyle='#2b6b6b'; ctx.fillRect(this.x,0,pipeWidth,this.gapY-pipeGap/2);
        const bottomY=this.gapY+pipeGap/2; ctx.fillRect(this.x,bottomY,pipeWidth,H-bottomY);}
    };
  }

  function checkCollision(b,p){
    const bx1=b.x-b.w/2, bx2=b.x+b.w/2, by1=b.y-b.h/2, by2=b.y+b.h/2;
    const topY2=p.gapY-pipeGap/2, bottomY1=p.gapY+pipeGap/2;
    const px1=p.x, px2=p.x+pipeWidth;
    return (bx2>px1 && bx1<px2 && (by1<topY2 || by2>bottomY1)) || by2>=H || by1<=0;
  }

  function clear(){ ctx.clearRect(0,0,W,H); }

  function drawBackground(){
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#70c5ce'); grad.addColorStop(0.8,'#6abf96');
    ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#d2b48c'; ctx.fillRect(0,H-60,W,60);
  }

  function drawBird(b){ ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.rotation); ctx.drawImage(b.img,-b.w/2,-b.h/2,b.w,b.h); ctx.restore(); }

  function update(){
    if(!running) return;
    frame++; bird.update();
    if(frame%Math.floor(pipeSpacing/pipeSpeed)===0)pipes.push(spawnPipe(W+20));
    for(let i=pipes.length-1;i>=0;i--){
      const p=pipes[i]; p.update();
      if(!p.passed && p.x+pipeWidth<bird.x){ score++; p.passed=true;}
      if(checkCollision(bird,p)) endGame();
      if(p.offScreen()) pipes.splice(i,1);
    }
    if(bird.y+bird.h/2>=H) endGame();
    scoreEl.textContent=score;
  }

  function draw(){ clear(); drawBackground(); pipes.forEach(p=>p.draw(ctx)); drawBird(bird); }

  function loop(){ update(); draw(); if(running) requestAnimationFrame(loop); }

  function startGame(){
    if(playerInput.value.trim()===''){ alert('Enter your name first'); return; }
    playerName=playerInput.value.trim();
    pipes=[]; frame=0; score=0; scoreEl.textContent=score;
    bird.x=80; bird.y=H/2; bird.vy=0;
    running=true; msgBox.style.display='none';
    for(let i=0;i<3;i++) pipes.push(spawnPipe(W+i*pipeSpacing+140));
    requestAnimationFrame(loop);
  }

  function saveScore(name, score){
    database.ref('scores').push({name, score});
  }

  function showLeaderboard(){
    const scoresRef=database.ref('scores');
    scoresRef.orderByChild('score').limitToLast(5).once('value', snapshot=>{
      const top=[]; snapshot.forEach(child=>top.push(child.val())); top.reverse();
      leaderboardDiv.innerHTML='<strong>Top 5:</strong><br>'+top.map(s=>`${s.name}: ${s.score}`).join('<br>');
    });
  }

  function endGame(){
    if(!running) return;
    running=false;
    playSound(hitSound);
    bestScore=Math.max(bestScore,score);
    saveScore(playerName, score);
    showLeaderboard();
    msgText.innerHTML=`Game Over<br>Score: ${score}<br>Best: ${bestScore}`;
    msgBox.style.display='block';
    playerInput.focus(); // üî• ensures input ready when game over
  }

  function doFlap(){ if(!bird) return; if(!running) startGame(); bird.flap(); }

  function playSound(audio){ if(!soundsUnlocked) return; audio.currentTime=0; audio.play(); }

  function unlockSounds(){ if(soundsUnlocked) return; flapSound.play().then(()=>flapSound.pause()); hitSound.play().then(()=>hitSound.pause()); soundsUnlocked=true; }

  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); unlockSounds(); doFlap(); }});
  canvas.addEventListener('mousedown', e=>{ unlockSounds(); doFlap(); });

  // ‚úÖ FIX: don't block taps on inputs/buttons
  window.addEventListener('touchstart', e=>{
    if (e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON") {
      e.preventDefault();
      unlockSounds();
      doFlap();
    }
  }, {passive:false});

  startBtn.addEventListener('click', startGame);

  const birdImg = new Image();
  birdImg.src = birdImageSrc;
  birdImg.onload = ()=>{ bird=createBird(birdImg); msgBox.style.display='block'; playerInput.focus(); }
})();
</script>
</body>
</html>
