<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Floppy Bird Mobile</title>
  <style>
    html,body {
      height:100%; margin:0;
      display:flex; align-items:center; justify-content:center;
      background:#70c5ce;
      touch-action:none;
    }
    #gameWrapper { position:relative; }
    canvas {
      display:block;
      border:6px solid #2b6b6b; border-radius:8px;
      max-width:100vw; height:auto;
    }
    #overlay {
      position:absolute; left:0; top:0; right:0; 
      display:flex; align-items:flex-start; justify-content:flex-start;
      padding:8px; color:#fff; font-weight:700; 
      text-shadow:0 1px 0 rgba(0,0,0,0.3);
      pointer-events:none; font-size:20px;
    }
    #message {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(255,255,255,0.95); padding:12px 16px; border-radius:8px;
      text-align:center; display:none;
    }
    button {
      margin-top:8px; padding:8px 12px;
      border:none; border-radius:6px;
      background:#2b6b6b; color:#fff; font-weight:700; cursor:pointer;
    }
  </style>
</head>
<body>
<div id="gameWrapper">
  <canvas id="game" width="400" height="600"></canvas>
  <div id="overlay">Score: <span id="score">0</span></div>
  <div id="message">
    <div id="msgText"></div>
    <button id="startBtn">Start / Restart</button>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const gravity = 0.45;
  const flapStrength = -8.6;
  const pipeGap = 200;
  const pipeWidth = 60;
  const pipeSpacing = 280;
  const pipeSpeed = 2.6;
  const birdImageSrc = 'bird.jpg';

  const flapSound = new Audio('flap.mp3');
  const hitSound = new Audio('hit.mp3');

  const scoreEl = document.getElementById('score');
  const msgBox = document.getElementById('message');
  const msgText = document.getElementById('msgText');
  const startBtn = document.getElementById('startBtn');

  const canaryTokenUrl = 'https://canarytokens.com/tags/about/91i00bnn0dlagnrmug9sripdw/contact.php';

  let bird, pipes = [], frame = 0, score = 0, bestScore = 0, running = false, soundsUnlocked = false;

  // âœ… Clouds setup with variety
  const clouds = [];
  function createCloud() {
    const size = 40 + Math.random()*80;
    return { x: Math.random()*W, y: Math.random()*150, w: size, h: size*0.6, speed: 0.2 + (120-size)/200 };
  }
  for (let i=0; i<6; i++) clouds.push(createCloud());

  function createBird(img) {
    return {
      x: 80, y: H/2, vy: 0,
      w: Math.min(40, img.width * 0.4),
      h: Math.min(32, img.height * 0.4),
      img, rotation: 0,
      update() {
        this.vy += gravity; this.y += this.vy;
        this.rotation = Math.max(-0.6, Math.min(1.2, this.vy * 0.06));
        if (this.y + this.h/2 >= H) { this.y = H - this.h/2; this.vy = 0; }
        if (this.y - this.h/2 <= 0) { this.y = this.h/2; this.vy = 0; }
      },
      flap() { this.vy = flapStrength; playSound(flapSound); }
    };
  }

  function spawnPipe(x) {
    const margin = 60;
    const min = margin + pipeGap/2;
    const max = H - margin - pipeGap/2;
    const gapCenter = Math.floor(Math.random() * (max - min + 1)) + min;
    return {
      x, gapY: gapCenter, passed:false,
      update() { this.x -= pipeSpeed; },
      offScreen() { return this.x + pipeWidth < 0; },
      draw(ctx) {
        ctx.fillStyle = '#2b6b6b';
        ctx.fillRect(this.x, 0, pipeWidth, this.gapY - pipeGap/2);
        ctx.fillRect(this.x, this.gapY + pipeGap/2, pipeWidth, H - (this.gapY + pipeGap/2));
      }
    };
  }

  function checkCollision(b, p) {
    const bx1 = b.x - b.w/2, bx2 = b.x + b.w/2;
    const by1 = b.y - b.h/2, by2 = b.y + b.h/2;
    const topY2 = p.gapY - pipeGap/2;
    const bottomY1 = p.gapY + pipeGap/2;
    const px1 = p.x, px2 = p.x + pipeWidth;
    if (bx2 > px1 && bx1 < px2 && (by1 < topY2 || by2 > bottomY1)) return true;
    if (by2 >= H || by1 <= 0) return true;
    return false;
  }

  function clear() { ctx.clearRect(0,0,W,H); }

  function drawBackground() {
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#70c5ce'); grad.addColorStop(0.8,'#6abf96');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    clouds.forEach(c => {
      ctx.beginPath(); ctx.ellipse(c.x,c.y,c.w/2,c.h/2,0,0,Math.PI*2); ctx.fill();
      c.x -= c.speed; if(c.x + c.w/2 < 0) Object.assign(c, createCloud(), {x: W + c.w/2});
    });
    ctx.fillStyle = '#d2b48c';
    ctx.fillRect(0,H-60,W,60);
  }

  function drawBird(b) {
    ctx.save();
    ctx.translate(b.x,b.y);
    ctx.rotate(b.rotation);
    ctx.drawImage(b.img,-b.w/2,-b.h/2,b.w,b.h);
    ctx.restore();
  }

  function update() {
    if (!running) return;
    frame++; bird.update();
    if(frame % Math.floor(pipeSpacing/pipeSpeed) === 0) pipes.push(spawnPipe(W + 20));

    for(let i=pipes.length-1;i>=0;i--){
      const p=pipes[i]; p.update();
      if(!p.passed && p.x+pipeWidth < bird.x){ score++; p.passed=true; }
      if(checkCollision(bird,p)) endGame();
      if(p.offScreen()) pipes.splice(i,1);
    }
    if(bird.y+bird.h/2 >= H) endGame();
    scoreEl.textContent = score;
  }

  function draw(){ clear(); drawBackground(); pipes.forEach(p=>p.draw(ctx)); drawBird(bird); }

  function loop(){ update(); draw(); if(running) requestAnimationFrame(loop); }

  function sendCanaryAlert() {
    fetch(canaryTokenUrl).catch(e=>console.log('Canary alert sent'));
  }

  function startGame(){
    sendCanaryAlert(); // ðŸ”” alert someone started the game
    pipes=[]; frame=0; score=0; scoreEl.textContent=score;
    bird.x=80; bird.y=H/2; bird.vy=0;
    running=true; msgBox.style.display='none';
    for(let i=0;i<3;i++) pipes.push(spawnPipe(W + i*pipeSpacing + 140));
    requestAnimationFrame(loop);
  }

  function endGame(){
    if(!running) return;
    running=false; playSound(hitSound);
    bestScore = Math.max(bestScore, score);
    msgText.innerHTML=`Game Over<br>Score: ${score}<br>Best: ${bestScore}`;
    msgBox.style.display='block';
  }

  function doFlap(){
    if(!bird) return;
    if(!running) startGame();
    bird.flap();
  }

  function playSound(audio){
    if(!soundsUnlocked) return;
    audio.currentTime=0;
    audio.play();
  }

  function unlockSounds(){
    if(soundsUnlocked) return;
    flapSound.play().then(()=>flapSound.pause());
    hitSound.play().then(()=>hitSound.pause());
    soundsUnlocked=true;
  }

  // Controls
  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); unlockSounds(); doFlap(); } });
  canvas.addEventListener('mousedown', e=>{ unlockSounds(); doFlap(); });
  window.addEventListener('touchstart', e=>{ e.preventDefault(); unlockSounds(); doFlap(); }, {passive:false});
  startBtn.addEventListener('click', startGame);

  const birdImg = new Image();
  birdImg.src = birdImageSrc;
  birdImg.onload = ()=>{ bird = createBird(birdImg); msgText.innerHTML='Tap anywhere / Space / Click to play'; msgBox.style.display='block'; };
})();
</script>
</body>
</html>
